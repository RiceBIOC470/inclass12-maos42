%Inclass 12. 

% Continue with the set of images you used for inclass 11, the same time 
% point (t = 30)

% 1. Use the channel that marks the cell nuclei. Produce an appropriately
% smoothed image with the background subtracted. 

file='011917-wntDose-esi017-RI_f0016.tif';
reader=bfGetReader(file);
x=reader.getSizeX;
y=reader.getSizeY;
zplane=reader.getSizeZ;
chan=reader.getSizeC;
time=reader.getSizeT;

plane1=reader.getIndex(zplane-1,chan-1,29)+1;
img1=bfGetPlane(reader,plane1); %esta es la membrana !!!!! 
imshow(img1,[]) %tiene que haber los corchetes pq si no, daña la img.

img1_sm=imfilter(img1,fspecial('gaussian',4,2));
imshow(img1_sm,[]); %just for checking the smoothing

img1_bg=imopen(img1_sm,strel('disk',150)); 
imshow(img1_bg,[])% just for checking step by step
img1_sm_bgsub=imsubtract(img1_sm,img1_bg);
imshow(img1_sm_bgsub,[0 700]);

% 2. threshold this image to get a mask that marks the cell nuclei. 

nimg=img1_sm_bgsub>100;
imshow(nimg, []); %for checking things % there are around 11 cells

img_label=bwlabel(nimg);
imshow(img_label);
colormap('jet');
caxis([0 350]); %not working :/

cellproperties=regionprops(nimg,'Area','Centroid','Image','PixelIdxList');
hist([cellproperties.Area]);
xlabel('Area'); ylabel('Frequency');
ids=find([cellproperties.Area]>4300); %I need a low number
imshow(cellproperties(ids(1)).Image);

img1cell=false(1024);
img1cell(cellproperties(ids(1)).PixelIdxList)=true;
imshow(img1cell);

% 3. Use any morphological operations you like to improve this mask (i.e.
% no holes in nuclei, no tiny fragments etc.)



% 4. Use the mask together with the images to find the mean intensity for
% each cell nucleus in each of the two channels. Make a plot where each data point 
% represents one nucleus and these two values are plotted against each other

